<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Predictor de Vuelos - Dashboard ‚úàÔ∏è</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='index.css') }}"
    />
  </head>
  <body>
    <!-- NAVBAR INNOVADOR -->
    <nav class="navbar navbar-expand-lg navbar-custom">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="fas fa-plane-departure"></i>
          <span>AeroPredict</span>
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" onclick="mostrarSeccion('predictor')">
                <i class="fas fa-magic"></i> Predecir
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" onclick="mostrarSeccion('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" onclick="mostrarSeccion('historial')">
                <i class="fas fa-history"></i> Historial
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" onclick="mostrarSeccion('perfil')">
                <i class="fas fa-user"></i> Perfil
              </a>
            </li>
          </ul>

          <div class="user-menu">
            <div class="dropdown">
              <div class="user-avatar" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle"></i>
              </div>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" onclick="mostrarSeccion('perfil')">
                    <i class="fas fa-cog"></i> Configuraci√≥n
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- SECCI√ìN PREDICTOR -->
      <div id="predictor" class="section active">
        <div class="predictor-card">
          <h2><i class="fas fa-magic"></i> Prediccion de Precios</h2>
          <form id="formulario">
            <div class="form-row">
              <div class="form-group">
                <label for="aerolinea">Aerol√≠nea</label>
                <select id="aerolinea" class="form-control" required></select>
              </div>
              <div class="form-group">
                <label for="fecha">Fecha del Viaje</label>
                <input type="date" id="fecha" class="form-control" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="origen">Origen</label>
                <select id="origen" class="form-control" required></select>
              </div>
              <div class="form-group">
                <label for="destino">Destino</label>
                <select id="destino" class="form-control" required></select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="hora_salida">Hora de Salida</label>
                <input
                  type="time"
                  id="hora_salida"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="duracion">Duraci√≥n (horas)</label>
                <input
                  type="number"
                  id="duracion"
                  class="form-control"
                  min="0"
                  step="0.1"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="escalas">Escalas</label>
                <select id="escalas" class="form-control" required>
                  <option value="0">Sin escalas</option>
                  <option value="1">1 escala</option>
                  <option value="2">2 escalas</option>
                </select>
              </div>
              <div class="form-group">
                <label for="informacion">Informaci√≥n Adicional</label>
                <select id="informacion" class="form-control" required></select>
              </div>
            </div>

            <button type="submit" class="btn-predict">
              <i class="fas fa-calculator"></i> Calcular Precio
            </button>
          </form>

          <div id="resultado" class="result-box">
            <div style="color: #667eea; font-weight: 600">
              Precio Estimado del Vuelo
            </div>
            <div class="price-display">
              <span class="price-currency">S/</span
              ><span id="precio">0.00</span>
            </div>
            <div style="color: #666; font-size: 14px">
              <div>
                <strong>Ruta:</strong> <span id="resultado-ruta">-</span>
              </div>
              <div>
                <strong>Aerol√≠nea:</strong>
                <span id="resultado-aerolinea">-</span>
              </div>
              <div>
                <strong>Fecha:</strong> <span id="resultado-fecha">-</span>
              </div>
              <small style="color: #999; margin-top: 10px"
                >Predicci√≥n autom√°tica basada en datos hist√≥ricos</small
              >
            </div>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN DASHBOARD -->
      <div id="dashboard" class="section">
        <h2 style="margin-bottom: 25px; color: var(--dark)">
          <i class="fas fa-chart-line"></i> Dashboard
        </h2>

        <div class="dashboard-grid" id="dashboard-stats">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-chart-bar" style="color: var(--primary)"></i>
            </div>
            <div class="stat-label">Total de Predicciones</div>
            <div class="stat-value" id="total-pred">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-dollar-sign" style="color: var(--success)"></i>
            </div>
            <div class="stat-label">Precio Promedio</div>
            <div class="stat-value">S/ <span id="promedio-precio">0</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-arrow-down" style="color: var(--info)"></i>
            </div>
            <div class="stat-label">Precio M√≠nimo</div>
            <div class="stat-value">S/ <span id="min-precio">0</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-arrow-up" style="color: var(--danger)"></i>
            </div>
            <div class="stat-label">Precio M√°ximo</div>
            <div class="stat-value">S/ <span id="max-precio">0</span></div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="chartPrecios"></canvas>
        </div>
      </div>
<!-- SECCI√ìN HISTORIAL -->
<div id="historial" class="section">
  <h2 style="margin-bottom: 25px; color: var(--dark)">
    <i class="fas fa-history"></i> Historial de Predicciones
  </h2>

  <div class="historial-table">
    <table class="table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Ruta</th>
          <th>Aerol√≠nea</th>
          <th>Precio</th>
          <th>Duraci√≥n</th>
        </tr>
      </thead>
      <tbody id="historial-body">
        <tr>
          <td colspan="5" style="text-align: center; color: #999">
            Cargando...
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Botones de exportaci√≥n -->
  <div class="export-buttons">
    <button class="btn-export btn-excel" onclick="exportarExcel()">
      <i class="fas fa-file-excel"></i> Exportar a Excel
    </button>
    <button class="btn-export btn-pdf" onclick="exportarPDF()">
      <i class="fas fa-file-pdf"></i> Exportar a PDF
    </button>
  </div>
</div>
      <!-- SECCI√ìN PERFIL -->
<!-- SECCI√ìN PERFIL -->
<div id="perfil" class="section">
  <div class="predictor-card">
    <h2><i class="fas fa-user"></i> Mi Perfil</h2>
    
    <!-- Informaci√≥n de usuario -->
    <div id="perfil-info" style="margin-top: 20px">
      <div class="form-group">
        <label>Usuario</label>
        <input type="text" class="form-control" id="perfil-usuario-input" disabled>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" class="form-control" id="perfil-email-input" disabled>
      </div>
      <div class="form-group">
        <label>Miembro desde</label>
        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px" id="perfil-fecha">-</div>
      </div>
      <div class="form-group">
        <label>Total de Predicciones</label>
        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px" id="perfil-total">-</div>
      </div>
      
      <!-- Botones de acci√≥n -->
      <div class="perfil-actions">
        <button class="btn-edit" onclick="habilitarEdicion()">
          <i class="fas fa-edit"></i> Editar Informaci√≥n
        </button>
        <button class="btn-edit" onclick="mostrarCambiarContrasena()">
          <i class="fas fa-key"></i> Cambiar Contrase√±a
        </button>
      </div>
      
      <!-- Botones para guardar/cancelar (ocultos inicialmente) -->
      <div class="perfil-save-actions" id="perfil-save-actions" style="display: none">
        <button class="btn-save" onclick="guardarPerfil()">
          <i class="fas fa-save"></i> Guardar Cambios
        </button>
        <button class="btn-cancel" onclick="cancelarEdicion()">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
    
    <!-- Formulario de cambio de contrase√±a (oculto inicialmente) -->
    <div id="cambiar-contrasena-form" style="display: none; margin-top: 30px">
      <h3 style="color: var(--dark); margin-bottom: 20px">
        <i class="fas fa-lock"></i> Cambiar Contrase√±a
      </h3>
      <div class="form-group">
        <label>Contrase√±a Actual</label>
        <input type="password" class="form-control" id="contrasena-actual" required>
      </div>
      <div class="form-group">
        <label>Nueva Contrase√±a</label>
        <input type="password" class="form-control" id="nueva-contrasena" minlength="6" required>
        <small style="color: #999">M√≠nimo 6 caracteres</small>
      </div>
      <div class="form-group">
        <label>Confirmar Nueva Contrase√±a</label>
        <input type="password" class="form-control" id="confirmar-nueva-contrasena" required>
      </div>
      <div class="perfil-save-actions">
        <button class="btn-save" onclick="cambiarContrasena()">
          <i class="fas fa-check"></i> Cambiar Contrase√±a
        </button>
        <button class="btn-cancel" onclick="ocultarCambiarContrasena()">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
      let chart = null;

      document.addEventListener("DOMContentLoaded", () => {
        const hoy = new Date().toISOString().split("T")[0];
        document.getElementById("fecha").min = hoy;

        cargarDatos();
        cargarDashboard();
        cargarHistorial();
        cargarPerfil();
      });

      function mostrarSeccion(seccion) {
        // Ocultar todas las secciones
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document
          .querySelectorAll(".nav-link")
          .forEach((l) => l.classList.remove("active"));

        // Mostrar secci√≥n seleccionada
        document.getElementById(seccion).classList.add("active");
        event.target.closest(".nav-link")?.classList.add("active");

        // Cargar datos din√°micos
        if (seccion === "dashboard") {
          cargarDashboard();
        } else if (seccion === "historial") {
          cargarHistorial();
        } else if (seccion === "perfil") {
          cargarPerfil();
        }
      }

      async function cargarDatos() {
        try {
          const res = await fetch("/api/datos");
          const data = await res.json();

          llenarSelect("aerolinea", data.aerolineas);
          llenarSelect("origen", data.origenes);
          llenarSelect("destino", data.destinos);
          llenarSelect("informacion", data.informaciones);
        } catch (e) {
          console.error("Error cargando datos:", e);
        }
      }

      function llenarSelect(id, valores) {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">Seleccionar...</option>';
        valores.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });
      }

      document
        .getElementById("formulario")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const datos = {
            aerolinea: document.getElementById("aerolinea").value,
            fecha: document.getElementById("fecha").value,
            origen: document.getElementById("origen").value,
            destino: document.getElementById("destino").value,
            hora_salida: document.getElementById("hora_salida").value,
            duracion: document.getElementById("duracion").value,
            escalas: document.getElementById("escalas").value,
            informacion: document.getElementById("informacion").value,
          };

          try {
            const res = await fetch("/api/predecir", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(datos),
            });

            const result = await res.json();

            if (result.exito) {
              document.getElementById("precio").textContent =
                result.precio.toFixed(2);
              document.getElementById("resultado-ruta").textContent =
                result.ruta;
              document.getElementById("resultado-aerolinea").textContent =
                result.aerolinea;
              document.getElementById("resultado-fecha").textContent =
                result.fecha;
              document.getElementById("resultado").classList.add("show");

              document.getElementById("formulario").reset();
            
            // Restablecer fecha m√≠nima
            const hoy = new Date().toISOString().split("T")[0];
            document.getElementById("fecha").min = hoy;
            } else {
              alert("Error: " + result.error);
            }
          } catch (e) {
            alert("Error al predecir: " + e);
          }
        });

      async function cargarDashboard() {
        try {
          const res = await fetch("/api/historial-json");
          const predicciones = await res.json();

          if (predicciones.length > 0) {
            const precios = predicciones.map((p) => p.precio);
            document.getElementById("total-pred").textContent =
              predicciones.length;
            document.getElementById("promedio-precio").textContent = (
              precios.reduce((a, b) => a + b) / precios.length
            ).toFixed(2);
            document.getElementById("min-precio").textContent = Math.min(
              ...precios
            ).toFixed(2);
            document.getElementById("max-precio").textContent = Math.max(
              ...precios
            ).toFixed(2);

            // Gr√°fico
            if (chart) chart.destroy();
            const ctx = document
              .getElementById("chartPrecios")
              .getContext("2d");
            chart = new Chart(ctx, {
              type: "line",
              data: {
                labels: predicciones.map((p) => p.fecha),
                datasets: [
                  {
                    label: "Precio Predicho (S/)",
                    data: precios,
                    borderColor: "#667eea",
                    backgroundColor: "rgba(102, 126, 234, 0.1)",
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 6,
                    pointBackgroundColor: "#667eea",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    labels: { color: "#666", font: { size: 14 } },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: "rgba(0,0,0,0.05)" },
                    ticks: { color: "#666" },
                  },
                  x: {
                    grid: { display: false },
                    ticks: { color: "#666" },
                  },
                },
              },
            });
          } else {
            document.getElementById("total-pred").textContent = "0";
            document.getElementById("promedio-precio").textContent = "0";
            document.getElementById("min-precio").textContent = "0";
            document.getElementById("max-precio").textContent = "0";
          }
        } catch (e) {
          console.error("Error cargando dashboard:", e);
        }
      }

      async function cargarHistorial() {
        try {
          const res = await fetch("/api/historial-json");
          const predicciones = await res.json();

          const tbody = document.getElementById("historial-body");
          tbody.innerHTML = "";

          if (predicciones.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align: center; color: #999;">No hay predicciones a√∫n</td></tr>';
            return;
          }

          predicciones.forEach((p) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                        <td>${p.fecha}</td>
                        <td><strong>${p.ruta}</strong></td>
                        <td>${p.aerolinea}</td>
                        <td><span class="badge-custom badge-price">S/ ${p.precio.toFixed(
                          2
                        )}</span></td>
                        <td><small>${p.hora}</small></td>
                    `;
            tbody.appendChild(tr);
          });
        } catch (e) {
          console.error("Error cargando historial:", e);
        }
      }


      async function cargarPerfil() {
        try {
          const res = await fetch("/api/perfil");
          const perfil = await res.json();
      
          document.getElementById("perfil-usuario-input").value = perfil.usuario;
          document.getElementById("perfil-email-input").value = perfil.email;
          document.getElementById("perfil-fecha").textContent = perfil.fecha_creacion;
          document.getElementById("perfil-total").textContent = perfil.total_predicciones + " predicciones";
        } catch (e) {
          console.error("Error cargando perfil:", e);
        }
      }
      
      // ============ FUNCIONES NUEVAS DE EDICI√ìN ============
      
      function habilitarEdicion() {
        document.getElementById("perfil-usuario-input").disabled = false;
        document.getElementById("perfil-email-input").disabled = false;
        document.querySelector(".perfil-actions").style.display = "none";
        document.getElementById("perfil-save-actions").style.display = "flex";
      }
      
      function cancelarEdicion() {
        document.getElementById("perfil-usuario-input").disabled = true;
        document.getElementById("perfil-email-input").disabled = true;
        document.querySelector(".perfil-actions").style.display = "flex";
        document.getElementById("perfil-save-actions").style.display = "none";
        cargarPerfil(); // Recargar datos originales
      }
      
      async function guardarPerfil() {
        const usuario = document.getElementById("perfil-usuario-input").value.trim();
        const email = document.getElementById("perfil-email-input").value.trim();
      
        if (!usuario || !email) {
          alert("Todos los campos son obligatorios");
          return;
        }
      
        try {
          const res = await fetch("/api/perfil/actualizar", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ usuario, email })
          });
      
          const result = await res.json();
      
          if (result.exito) {
            alert("‚úì " + result.mensaje);
            cancelarEdicion();
            cargarPerfil();
          } else {
            alert("‚úó " + result.error);
          }
        } catch (e) {
          alert("Error al actualizar perfil: " + e);
        }
      }
      
      function mostrarCambiarContrasena() {
        document.getElementById("perfil-info").style.display = "none";
        document.getElementById("cambiar-contrasena-form").style.display = "block";
      }
      
      function ocultarCambiarContrasena() {
        document.getElementById("perfil-info").style.display = "block";
        document.getElementById("cambiar-contrasena-form").style.display = "none";
        // Limpiar campos
        document.getElementById("contrasena-actual").value = "";
        document.getElementById("nueva-contrasena").value = "";
        document.getElementById("confirmar-nueva-contrasena").value = "";
      }
      
      async function cambiarContrasena() {
        const contrasena_actual = document.getElementById("contrasena-actual").value;
        const nueva_contrasena = document.getElementById("nueva-contrasena").value;
        const confirmar_contrasena = document.getElementById("confirmar-nueva-contrasena").value;
      
        if (!contrasena_actual || !nueva_contrasena || !confirmar_contrasena) {
          alert("Todos los campos son obligatorios");
          return;
        }
      
        if (nueva_contrasena.length < 6) {
          alert("La nueva contrase√±a debe tener al menos 6 caracteres");
          return;
        }
      
        if (nueva_contrasena !== confirmar_contrasena) {
          alert("Las contrase√±as no coinciden");
          return;
        }
      
        try {
          const res = await fetch("/api/perfil/cambiar-contrasena", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contrasena_actual,
              nueva_contrasena,
              confirmar_contrasena
            })
          });
      
          const result = await res.json();
      
          if (result.exito) {
            alert("‚úì " + result.mensaje);
            ocultarCambiarContrasena();
          } else {
            alert("‚úó " + result.error);
          }
        } catch (e) {
          alert("Error al cambiar contrase√±a: " + e);
        }
      }
// ============ FUNCIONES DE EXPORTACI√ìN ============

async function exportarExcel() {
  try {
    const response = await fetch('/api/historial/exportar-excel');
    
    if (!response.ok) {
      const error = await response.json();
      alert('Error: ' + error.error);
      return;
    }
    
    // Descargar archivo
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `historial_${new Date().getTime()}.xlsx`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    alert('‚úì Excel exportado exitosamente');
  } catch (e) {
    alert('Error al exportar Excel: ' + e);
    console.error(e);
  }
}

async function exportarPDF() {
  try {
    const response = await fetch('/api/historial/exportar-pdf');
    
    if (!response.ok) {
      const error = await response.json();
      alert('Error: ' + error.error);
      return;
    }
    
    // Descargar archivo
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `historial_${new Date().getTime()}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    alert('‚úì PDF exportado exitosamente');
  } catch (e) {
    alert('Error al exportar PDF: ' + e);
    console.error(e);
  }
}
      
    </script>
  <!-- ============================================ -->
<!-- AGREGAR ESTE C√ìDIGO ANTES DE </body> -->
<!-- ============================================ -->

<!-- BOT DE CHAT FLOTANTE -->
<div id="chat-bot-container">
  <!-- Bot√≥n flotante -->
  <button id="chat-bot-toggle" class="chat-bot-button" onclick="toggleChatBot()">
    <i class="fas fa-robot"></i>
    <span class="chat-badge" id="chat-badge" style="display: none;">1</span>
  </button>

  <!-- Ventana del chat -->
  <div id="chat-bot-window" class="chat-bot-window">
    <div class="chat-bot-header">
      <div class="chat-bot-title">
        <i class="fas fa-robot"></i>
        <span>Asistente de Vuelos IA</span>
        <span class="chat-bot-status">
          <i class="fas fa-circle"></i> En l√≠nea
        </span>
      </div>
      <button class="chat-bot-close" onclick="toggleChatBot()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="chat-bot-messages" class="chat-bot-messages">
      <div class="chat-message bot-message">
        <div class="message-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
          <div class="message-text">
            ¬°Hola! üëã Soy tu asistente inteligente de vuelos.
            <br><br>
            Puedo ayudarte a:
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>üìä Analizar precios hist√≥ricos de rutas</li>
              <li>üèñÔ∏è Identificar temporada alta/baja</li>
              <li>‚è∞ Recomendar cu√°ndo comprar</li>
              <li>‚úàÔ∏è Comparar aerol√≠neas y escalas</li>
              <li>üéØ Sugerencias personalizadas</li>
            </ul>
            ¬øEn qu√© te puedo ayudar hoy?
          </div>
          <div class="message-time">Ahora</div>
        </div>
      </div>
    </div>

    <div id="chat-typing-indicator" class="chat-typing-indicator" style="display: none;">
      <div class="message-avatar">
        <i class="fas fa-robot"></i>
      </div>
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div class="chat-bot-input">
      <button class="chat-quick-action" onclick="enviarPreguntaRapida('¬øCu√°l es el mejor momento para comprar?')" title="Pregunta r√°pida">
        <i class="fas fa-lightbulb"></i>
      </button>
      <input 
        type="text" 
        id="chat-input" 
        placeholder="Escribe tu pregunta..." 
        onkeypress="if(event.key === 'Enter') enviarMensaje()"
      />
      <button class="chat-send-button" onclick="enviarMensaje()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>

    <div class="chat-quick-suggestions" id="chat-suggestions">
      <button onclick="enviarPreguntaRapida('Analiza mi √∫ltima predicci√≥n')">
        üìä Analizar predicci√≥n
      </button>
      <button onclick="enviarPreguntaRapida('¬øCu√°ndo es temporada alta?')">
        üèñÔ∏è Temporadas
      </button>
      <button onclick="enviarPreguntaRapida('Compara aerol√≠neas')">
        ‚úàÔ∏è Comparar
      </button>
    </div>
  </div>
</div>

<style>
/* ============= ESTILOS DEL CHAT BOT ============= */
#chat-bot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.chat-bot-button {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
  transition: all 0.3s ease;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-bot-button:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
}

.chat-bot-button i {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.chat-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ff4757;
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 11px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
}

.chat-bot-window {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 400px;
  height: 600px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
  animation: slideUp 0.3s ease;
}

.chat-bot-window.active {
  display: flex;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-bot-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 16px 16px 0 0;
}

.chat-bot-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 16px;
}

.chat-bot-title i {
  font-size: 20px;
}

.chat-bot-status {
  font-size: 11px;
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 5px;
  margin-left: 10px;
}

.chat-bot-status i {
  font-size: 8px;
  color: #4ade80;
  animation: blink 2s infinite;
}

@keyframes blink {
  0%, 50%, 100% { opacity: 1; }
  25%, 75% { opacity: 0.3; }
}

.chat-bot-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.chat-bot-close:hover {
  background: rgba(255, 255, 255, 0.3);
}

.chat-bot-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: #f8f9fa;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.chat-bot-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-bot-messages::-webkit-scrollbar-track {
  background: transparent;
}

.chat-bot-messages::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

.chat-message {
  display: flex;
  gap: 12px;
  animation: messageSlide 0.3s ease;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.bot-message .message-avatar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.user-message .message-avatar {
  background: linear-gradient(135deg, #4ade80 0%, #10b981 100%);
  color: white;
  order: 2;
}

.message-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.user-message .message-content {
  align-items: flex-end;
}

.message-text {
  background: white;
  padding: 12px 16px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  max-width: 280px;
  line-height: 1.5;
  font-size: 14px;
  color: #2d3748;
}

.user-message .message-text {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.message-time {
  font-size: 11px;
  color: #a0aec0;
  padding: 0 8px;
}

.chat-typing-indicator {
  display: flex;
  gap: 12px;
  padding: 0 20px;
  animation: messageSlide 0.3s ease;
}

.typing-dots {
  background: white;
  padding: 12px 16px;
  border-radius: 12px;
  display: flex;
  gap: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.typing-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #cbd5e0;
  animation: typingDot 1.4s infinite;
}

.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingDot {
  0%, 60%, 100% {
    transform: translateY(0);
    background: #cbd5e0;
  }
  30% {
    transform: translateY(-10px);
    background: #667eea;
  }
}

.chat-bot-input {
  padding: 16px 20px;
  background: white;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 10px;
  align-items: center;
}

.chat-quick-action {
  width: 40px;
  height: 40px;
  border: none;
  background: #f7fafc;
  color: #667eea;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-quick-action:hover {
  background: #edf2f7;
  transform: scale(1.05);
}

#chat-input {
  flex: 1;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 14px;
  outline: none;
  transition: all 0.2s;
}

#chat-input:focus {
  border-color: #667eea;
  background: #f7fafc;
}

.chat-send-button {
  width: 40px;
  height: 40px;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-send-button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.chat-send-button:active {
  transform: scale(0.95);
}

.chat-quick-suggestions {
  padding: 12px 20px;
  background: white;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.chat-quick-suggestions button {
  padding: 8px 14px;
  background: #f7fafc;
  border: 1px solid #e2e8f0;
  border-radius: 20px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  color: #4a5568;
}

.chat-quick-suggestions button:hover {
  background: #667eea;
  color: white;
  border-color: #667eea;
  transform: translateY(-2px);
}

@media (max-width: 768px) {
  .chat-bot-window {
    width: calc(100vw - 40px);
    height: calc(100vh - 100px);
    right: 20px;
    bottom: 90px;
  }
}
</style>

<script>
// ============ CHAT BOT JAVASCRIPT ============
let chatBotAbierto = false;
let ultimaPrediccion = null;
let conversacionActual = [];

function toggleChatBot() {
  const chatWindow = document.getElementById('chat-bot-window');
  const chatButton = document.getElementById('chat-bot-toggle');
  const chatBadge = document.getElementById('chat-badge');
  
  chatBotAbierto = !chatBotAbierto;
  
  if (chatBotAbierto) {
    chatWindow.classList.add('active');
    chatButton.style.transform = 'scale(0.9)';
    chatBadge.style.display = 'none';
    
    setTimeout(() => {
      const messages = document.getElementById('chat-bot-messages');
      messages.scrollTop = messages.scrollHeight;
    }, 100);
  } else {
    chatWindow.classList.remove('active');
    chatButton.style.transform = 'scale(1)';
  }
}

async function enviarMensaje() {
  const input = document.getElementById('chat-input');
  const mensaje = input.value.trim();
  
  if (!mensaje) return;
  
  agregarMensaje(mensaje, 'user');
  input.value = '';
  
  document.getElementById('chat-suggestions').style.display = 'none';
  mostrarIndicadorEscritura(true);
  
  await procesarMensajeIA(mensaje);
  
  mostrarIndicadorEscritura(false);
}

function enviarPreguntaRapida(pregunta) {
  document.getElementById('chat-input').value = pregunta;
  enviarMensaje();
}

function agregarMensaje(texto, tipo) {
  const messagesContainer = document.getElementById('chat-bot-messages');
  const ahora = new Date();
  const hora = ahora.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${tipo}-message`;
  
  messageDiv.innerHTML = `
    <div class="message-avatar">
      <i class="fas fa-${tipo === 'bot' ? 'robot' : 'user'}"></i>
    </div>
    <div class="message-content">
      <div class="message-text">${texto}</div>
      <div class="message-time">${hora}</div>
    </div>
  `;
  
  messagesContainer.appendChild(messageDiv);
  
  setTimeout(() => {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }, 100);
  
  conversacionActual.push({ role: tipo === 'user' ? 'user' : 'assistant', content: texto });
}

function mostrarIndicadorEscritura(mostrar) {
  const indicator = document.getElementById('chat-typing-indicator');
  indicator.style.display = mostrar ? 'flex' : 'none';
  
  if (mostrar) {
    const messages = document.getElementById('chat-bot-messages');
    messages.scrollTop = messages.scrollHeight;
  }
}

async function procesarMensajeIA(mensajeUsuario) {
  try {
    const contexto = await obtenerContextoPrediccion();
    
    const response = await fetch('/api/chat-bot', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        mensaje: mensajeUsuario,
        contexto: contexto,
        conversacion: conversacionActual.slice(-6)
      })
    });
    
    const data = await response.json();
    
    if (data.exito) {
      agregarMensaje(data.respuesta, 'bot');
      
      // NUEVO: Cerrar autom√°ticamente si el bot lo indica
      if (data.cerrar_chat) {
        setTimeout(() => {
          toggleChatBot();
          // Limpiar conversaci√≥n despu√©s de cerrar
          setTimeout(() => {
            conversacionActual = [];
          }, 500);
        }, 2000); // Espera 2 segundos antes de cerrar
      }
    } else {
      agregarMensaje('Lo siento, tuve un problema al procesar tu solicitud. ¬øPodr√≠as intentarlo de nuevo?', 'bot');
    }
  } catch (error) {
    console.error('Error en procesarMensajeIA:', error);
    agregarMensaje('Disculpa, estoy teniendo problemas de conexi√≥n. Por favor intenta m√°s tarde.', 'bot');
  }
}

async function obtenerContextoPrediccion() {
  try {
    const resHistorial = await fetch('/api/historial-json');
    const historial = await resHistorial.json();
    
    const resStats = await fetch('/api/estadisticas');
    const stats = await resStats.json();
    
    const ultimaPred = historial.length > 0 ? historial[0] : null;
    
    return {
      ultimaPrediccion: ultimaPred,
      totalPredicciones: historial.length,
      estadisticas: stats,
      historialReciente: historial.slice(0, 5)
    };
  } catch (error) {
    console.error('Error obteniendo contexto:', error);
    return null;
  }
}

// Capturar predicciones autom√°ticamente
const formularioOriginalSubmit = document.getElementById('formulario');
if (formularioOriginalSubmit) {
  formularioOriginalSubmit.addEventListener('submit', async function(e) {
    // El evento ya est√° manejado arriba, solo agregamos la notificaci√≥n del chat
    setTimeout(async () => {
      const resHistorial = await fetch('/api/historial-json');
      const historial = await resHistorial.json();
      
      if (historial.length > 0 && !chatBotAbierto) {
        const badge = document.getElementById('chat-badge');
        badge.style.display = 'flex';
        badge.textContent = '1';
      }
    }, 1500);
  });
}

console.log('‚úÖ Chat Bot Inteligente inicializado');
</script>  
    
  </body>
</html>
